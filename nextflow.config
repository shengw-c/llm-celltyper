/*
 * Nextflow configuration file for Cell Type Annotation Pipeline
 */

// Global default params
params {
    // Input parameters (to be specified by user)
    input_h5ad = null
    context = "single-cell RNA-seq data"
    batch_key = null
    integration = false
    cpus = 16
    outdir = "results"
    help = false
    
    // LLM Model Configuration
    llm_model = "gemini-2.5-flash"  // Default to flash (faster, cheaper); override with "gemini-2.5-pro" for complex tasks
    llm_max_retries = 3
    mock_llm = false    // Enable mock mode for testing without API calls
    
    // Annotation parameters
    min_cells = 500  // Minimum cells required for subtype annotation
    max_resolution = 1.0 // Max resolution for Leiden clustering
    transition_cutoff = 0.1 // Stability threshold for clustering
    
    // Feature extraction configuration
    top_genes = 20      // Number of top marker genes per cluster
    top_pathways = 20   // Number of top pathways per cluster
    
    // GSEA configuration
    gsea_databases = "MSigDB_Hallmark_2020,GO_Biological_Process_2025"
    
    // Logging configuration
    log_level = "INFO"  // Logging level: DEBUG, INFO, WARNING, ERROR
    
    // Pipeline metadata
    version = "2.0.0"
}

// Manifest
manifest {
    name = 'llm-celltyper-v2'
    author = 'Sheng'
    description = 'Hierarchical LLM-based cell type annotation pipeline v2'
    version = '2.0.0'
    nextflowVersion = '>=21.04.0'
}

// Process configuration
process {
    // Default process settings
    errorStrategy = 'retry'
    maxRetries = 2
    
    withName: 'ANNOTATE_CELL_TYPES' {
        cpus = params.cpus
        memory = { 50.GB * task.attempt }
        time = { 24.h * task.attempt }
    }
}

// Executor configuration
executor {
    name = 'local'
    queueSize = 4
}

// Enable trace and timeline
trace {
    enabled = true
    file = "${params.outdir}/pipeline_trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

timeline {
    enabled = true
    file = "${params.outdir}/pipeline_timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_report.html"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_dag.html"
    overwrite = true
}

// Conda/environment configuration
conda {
    enabled = false  // Set to true if using conda
    useMamba = false
}

// Profiles for different execution environments
profiles {
    // Standard local execution
    standard {
        process.executor = 'local'
        executor {
            queueSize = 10
        }
    }
    
    // SLURM cluster execution
    slurm {
        process {
            executor = 'slurm'
            
            // Error handling
            errorStrategy = { task.exitStatus in [104,134,137,139,140,143,247] ? 'retry' : 'finish' }
            maxRetries = 3
            maxErrors = '-1'
        }
        
        executor {
            perCpuMemAllocation = true
            queueSize = 10
        }
    }
    
    // Test profile with minimal resources and mock LLM
    test {
        params {
            cpus = 2
            llm_max_retries = 1
            min_cells = 100
            mock_llm = true
        }
        process {
            memory = '4 GB'
            time = '30m'
            errorStrategy = 'ignore'
        }
    }
    
    // Production profile with enhanced monitoring
    production {
        params {
            llm_max_retries = 5
        }
        process {
            errorStrategy = 'retry'
            maxRetries = 5
        }
        
        // Enhanced reporting
        trace.enabled = true
        timeline.enabled = true
        report.enabled = true
        dag.enabled = true
    }
}
